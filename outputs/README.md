# Reconciliation Outputs

This folder contains the output files generated by the reconciliation process.

## Overview

The reconciliation pipeline produces three main output files:
1. **Matched Records** - Successfully reconciled transactions
2. **Exception Queue** - Discrepancies requiring review and resolution

## Output Files

### 1. matched_orders_invoices.csv

**Purpose**: Contains all orders that were successfully matched to invoices.

**Criteria for Inclusion**:
- `recon_status = 'MATCHED'`
- Amount difference ≤ $0.01
- Date difference within ±5 days
- No exceptions or discrepancies

**Columns**:
- `order_id` - Unique order identifier
- `invoice_id` - Matching invoice identifier
- `customer_id` - Customer identifier
- `customer_name` - Customer name
- `order_date` - Date order was placed
- `invoice_date` - Date invoice was created
- `order_amount` - Total order amount
- `invoice_amount` - Total invoice amount
- `amount_diff` - Difference between amounts (should be ≤ $0.01)
- `date_diff_days` - Days between order and invoice
- `recon_status` - Always 'MATCHED'
- `reconciliation_run_date` - Timestamp when reconciliation was performed

**Source Query**: `sql/recon_orders_to_invoices.sql` (filtered for MATCHED status)

---

### 2. matched_invoices_ledger.csv

**Purpose**: Contains all invoices that were successfully matched to ledger entries.

**Criteria for Inclusion**:
- `recon_status = 'MATCHED'`
- Posted amount equals invoice amount (within $0.01)
- No pending entries
- No duplicate postings

**Columns**:
- `invoice_id` - Unique invoice identifier
- `order_id` - Related order identifier
- `customer_id` - Customer identifier
- `customer_name` - Customer name
- `invoice_date` - Date invoice was created
- `invoice_amount` - Total invoice amount
- `ledger_entry_count` - Number of ledger entries for this invoice
- `posted_amount` - Total amount posted to ledger
- `amount_diff` - Difference between invoice and posted amounts
- `first_posting_date` - Date of first ledger entry
- `last_posting_date` - Date of last ledger entry
- `days_to_post` - Days from invoice date to first posting
- `account_numbers` - List of GL account numbers used
- `entry_ids` - List of ledger entry IDs for audit trail
- `recon_status` - Always 'MATCHED'
- `reconciliation_run_date` - Timestamp when reconciliation was performed

**Source Query**: `sql/recon_invoices_to_ledger.sql` (filtered for MATCHED status)

---

### 3. exceptions.csv

**Purpose**: Contains all discrepancies and exceptions requiring manual review and resolution.

**Criteria for Inclusion**:
- `recon_status != 'MATCHED'`
- Any exceptions from either reconciliation layer

**Columns**:
- `record_type` - Type of record (ORDER, INVOICE)
- `record_id` - Unique identifier (order_id or invoice_id)
- `related_id` - Related record ID (invoice_id for orders, order_id for invoices)
- `customer_id` - Customer identifier
- `customer_name` - Customer name
- `record_date` - Date of the record (order_date or invoice_date)
- `exception_reason` - Specific exception type (NO_INVOICE, AMOUNT_DIFF, TIMING_DIFF, etc.)
- `expected_amount` - Expected amount based on source record
- `actual_amount` - Actual amount found (or 0 if missing)
- `amount_diff` - Dollar difference
- `amount_diff_pct` - Percentage difference
- `priority` - Priority level (1=Highest, 4=Lowest)
- `notes` - Detailed explanation of the exception
- `additional_details` - Extra context (date differences, entry counts, etc.)
- `reconciliation_run_date` - Timestamp when reconciliation was performed

**Source Queries**: 
- `sql/recon_orders_to_invoices.sql` (filtered for non-MATCHED status)
- `sql/recon_invoices_to_ledger.sql` (filtered for non-MATCHED status)

---

## Exception Reasons Reference

### Orders ↔ Invoices Exceptions

| Exception Reason | Description | Priority |
|-----------------|-------------|----------|
| `NO_INVOICE` | Order exists but no invoice found | 1 |
| `AMOUNT_DIFF` | Invoice amount doesn't match order amount | 1-2 |
| `TIMING_DIFF` | Invoice date outside ±5 day window | 3 |
| `AMOUNT_AND_TIMING_DIFF` | Both amount and timing issues | 1-2 |

### Invoices ↔ Ledger Exceptions

| Exception Reason | Description | Priority |
|-----------------|-------------|----------|
| `UNPOSTED_INVOICE` | Invoice not posted to ledger | 1 |
| `DUPLICATE_POSTING` | Ledger amount exceeds invoice amount | 1 |
| `UNDER_POSTED` | Ledger amount less than invoice | 2 |
| `PARTIAL_POSTING` | Some entries still pending | 2 |
| `AMOUNT_MISMATCH` | Posted amount doesn't match invoice | 2 |

---

## Generating Output Files

### Using SQL (Database)

If running in a database environment, use these queries to generate outputs:

```sql
-- Generate matched_orders_invoices.csv
SELECT * FROM recon_orders_to_invoices
WHERE recon_status = 'MATCHED'
ORDER BY order_date DESC;

-- Generate matched_invoices_ledger.csv
SELECT * FROM recon_invoices_to_ledger
WHERE recon_status = 'MATCHED'
ORDER BY invoice_date DESC;

-- Generate exceptions.csv (Orders to Invoices)
SELECT 
    'ORDER' AS record_type,
    order_id AS record_id,
    invoice_id AS related_id,
    customer_id,
    customer_name,
    order_date AS record_date,
    recon_status AS exception_reason,
    order_amount AS expected_amount,
    COALESCE(invoice_amount, 0) AS actual_amount,
    amount_diff,
    amount_diff_pct,
    priority,
    exception_notes AS notes,
    'Date difference: ' || CAST(date_diff_days AS VARCHAR) || ' days' AS additional_details,
    reconciliation_run_date
FROM recon_orders_to_invoices
WHERE recon_status != 'MATCHED'

UNION ALL

-- Generate exceptions.csv (Invoices to Ledger)
SELECT 
    'INVOICE' AS record_type,
    invoice_id AS record_id,
    order_id AS related_id,
    customer_id,
    customer_name,
    invoice_date AS record_date,
    recon_status AS exception_reason,
    invoice_amount AS expected_amount,
    posted_amount AS actual_amount,
    amount_diff,
    amount_diff_pct,
    priority,
    exception_notes AS notes,
    'Ledger entries: ' || CAST(ledger_entry_count AS VARCHAR) || ', Days to post: ' || CAST(days_to_post AS VARCHAR) AS additional_details,
    reconciliation_run_date
FROM recon_invoices_to_ledger
WHERE recon_status != 'MATCHED'

ORDER BY priority ASC, amount_diff_pct DESC;
```

### Using Python/Pandas

```python
import pandas as pd
from sqlalchemy import create_engine

# Connect to your database
engine = create_engine('your_connection_string')

# Generate matched records
matched_oi = pd.read_sql("""
    SELECT * FROM recon_orders_to_invoices 
    WHERE recon_status = 'MATCHED'
""", engine)
matched_oi.to_csv('outputs/matched_orders_invoices.csv', index=False)

matched_il = pd.read_sql("""
    SELECT * FROM recon_invoices_to_ledger 
    WHERE recon_status = 'MATCHED'
""", engine)
matched_il.to_csv('outputs/matched_invoices_ledger.csv', index=False)

# Generate exceptions (combined query from above)
exceptions = pd.read_sql("""[FULL UNION QUERY]""", engine)
exceptions.to_csv('outputs/exceptions.csv', index=False)
```

---

## File Naming Convention

For historical tracking, consider adding timestamps to filenames:

```
matched_orders_invoices_YYYY-MM-DD.csv
matched_invoices_ledger_YYYY-MM-DD.csv
exceptions_YYYY-MM-DD.csv
```

Example: `exceptions_2026-02-09.csv`

---

## Best Practices

1. **Archive Outputs**: Keep historical reconciliation runs for audit purposes
2. **Daily Runs**: Execute reconciliation daily to catch issues early
3. **Priority-Based Review**: Focus on Priority 1 exceptions first
4. **Track Resolutions**: Document how each exception was resolved
5. **Trend Analysis**: Monitor which exception types occur most frequently

---

## Questions or Issues?

If you encounter issues with the output files or need clarification on exception reasons, please contact the Finance Operations team.